<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>S-Messenger</title>
		<style>
			body {
				font-family: "Courier";
				font-size: 16px;
				font-weight: bold;
				color: #fff;
				background: #000000;
				margin: 0;
				padding: 0;
			}
			
			p {
				margin-bottom: 0;
				margin-top: 0;
			}
			
			::-webkit-scrollbar {
				width: 11px;
			}

			::-webkit-scrollbar-track {
				background: #000; 
				border: 1px;
				border-style: solid;
				border-color: #898989;
			}

			::-webkit-scrollbar-thumb {
				background: #474747; 
			}

			::-webkit-scrollbar-thumb:hover {
				background: #555; 
			}
			
			.bottomui {
				position:fixed;
				bottom:0;
				left:0;
				width: 100%;
			}
			
			.inputbox {
				background: #292929;
				color: #fff;
				border: none;
				outline: none;
				font-family: "Courier";
				font-size: 16px;
				font-weight: bold;
				height: 25px;
				width: calc(100% - 106px);
			}
			
			.uibutton {
				background: #191919;
				border: 1px solid #424242;
				font-family: "Courier";
				font-size: 16px;
				font-weight: bold;
				color: #fff;
				height: 25px;
				width: 106px;
				outline: none;
			}
			.uibutton:hover, .option:hover {
				background-color: #202020;
			}
			.uibutton:active, .option:active {
				background: #404040;
			}
			.fade {
				opacity: 1;
				-webkit-transition: opacity 1s linear;
			}
			
			.fade-quick {
				opacity: 0;
				-webkit-transition: opacity 0.1s linear;
			}
			
			.option {
				cursor:pointer;
				padding: 14px;
				display: block;
				background: #292929;
				color: #fff;
				border: 1px solid #424242;
			}
		</style>
		<script>
			//GLOBALVARS
			var username = "";
			var websocket;
			var connected = false;
			var lastElement;
			let deferredPrompt;

			//APPLICATION
			window.addEventListener('beforeinstallprompt', (e) => {
			  // Stash the event so it can be triggered later.
			  deferredPrompt = e;
			});
			if ('serviceWorker' in navigator) {
			  window.addEventListener('load', function() {
				navigator.serviceWorker.register('sw.js', {scope: '.'}).then(function(registration) {
				  // Registration was successful
				  console.log('ServiceWorker registration successful with scope: ', registration.scope);
				}, function(err) {
				  // registration failed :(
				  console.log('ServiceWorker registration failed: ', err);
				});
			  });
			}
			var CACHE_NAME = 'my-site-cache-v1';
			var urlsToCache = [
				'/',
				'/favicon.png',
				'/scpf.png',
				'/message.mp3',
				'/message1.mp3',
				'/manifest.json'
			];

			self.addEventListener('install', function(event) {
			  // Perform install steps
			  event.waitUntil(
				caches.open(CACHE_NAME)
				  .then(function(cache) {
					console.log('Opened cache');
					return cache.addAll(urlsToCache);
				  })
			  );
			});
			
			
			
			function Start(){
				var input = document.getElementById("chatInput");
				
				input.addEventListener("keyup", function(event) {
					if (event.keyCode === 13) {
						document.getElementById("sendButton").click();
					}
				});
				Notification.requestPermission();
			}
			
			function Load(){
				var servers = document.getElementById('servers');
				servers.className='fade';
				servers.style.opacity=1;
				document.getElementById('ws').value = "wss://connect.websocket.in/v2/1?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjY0NWJkYzI2OGQ2NjkxMmY3MzI5MWM1YWE4YmY3YmI5YTkzMzEwOGUwYjRiYjA4NDgyOGI4YzliMzczMGVkNjhmMGI1MGQ2NGM5ODZhNmE4In0.eyJhdWQiOiI4IiwianRpIjoiNjQ1YmRjMjY4ZDY2OTEyZjczMjkxYzVhYThiZjdiYjlhOTMzMTA4ZTBiNGJiMDg0ODI4YjhjOWIzNzMwZWQ2OGYwYjUwZDY0Yzk4NmE2YTgiLCJpYXQiOjE1ODMxNzE1OTcsIm5iZiI6MTU4MzE3MTU5NywiZXhwIjoxNjE0NzA3NTk3LCJzdWIiOiI1OTgiLCJzY29wZXMiOltdfQ.KJGvQbVglNPlFE9S0ScLTdaLARCRwTvv8YzeL-HyUYMVX37YDU0fQy88iUH1uDhKf3sSq-ljdyplhn9ukMcY4pHGYneEPXnVJzRMM0O3NF-U97JL4FPcHjUmNkXwYV-o1AWo-B5h3NcGAeuhVDoJGDXbjP7pQt0YhtPzfU4rhGw-9JrKwvXNLmq5J3qHV-m3BkpE4QdXfR2KIHO_Rr78x_ufGkneRGCxkE5nyW2vVLrP-_BDCKIvaP7dS6oob_gRvjmVMJaRITNKsbJqpyZBnkDvdKzXjxlgcvDQh2ZXMFT63RCIBh3o29lr7BlmOQs5CXCz7Tq0EFp8o4iHyWdnXAqoBIzadT1_0hkRo6KojYhMtLNpXDuba-7QvPBO556Bp8VzT0QLPSBdl6_N--LcqrQ90UtJpkiJIVf4dQLfST8TIitTHiqGg6cJSUkqhDwIACSMG7Ah_b09zzciJ8n_ILCEhclGH66L81jvvpGtHfnCsocBPJ_coIECAuyxC074T2s4gdj0Jral9GYtjeb4JGCmgtgMul1-vwk8wjWK4tT2LGsdiUqbnovhK-wNLa2V4gQnzb2H1YgKmf1LKcmUOxZMpnJFfXm6rBw-N6HzKLfq0O8QztGOsseU9f7nzQZQZLeixXIWd9MLI9tDzvzxsxhZHMl9cVa1jyU_9lVkOlw";
				document.getElementById('un').value = makeid(8);
			}
			
			function SendClick(){
				var input = document.getElementById("chatInput");
				if(input.value != ""){
					if(input.value.charAt(0) == '/'){
						var read="";
						for(let i=1; i<input.value.length; i++){
							if (input.value.charAt(i) == " "){
								break;
							}
							read += input.value.charAt(i);
						}
						console.log(read);
						switch (read){
							case "clr":
								var msgs = document.getElementsByClassName("chatMessage");
								while (msgs[0]) {
									msgs[0].parentNode.removeChild(msgs[0]);
								}
								break;
								
							case "check":
								Message('server', 'Online users:', '0');
								SendMessage('message', 'server', 'Online users:');
								
								SendMessage('check', 'server', '');
								
								Message('server', username, '0');
								SendMessage('message', 'server', username);
								break;
								
							case "username":
								var prs = "";
								for(let i=10; i<input.value.length; i++){
									prs+=input.value.charAt(i);
								}
								if(prs == ""){
									Message("server", "Invalid username.", "");
									return;
								}
								Message("server", username+" changed username to "+prs+".", "");
								SendMessage('message', 'server', username+" changed username to "+prs+".");
								username = prs;
								break;
								
							default:
								Message("server", "Unknown command.", "");
								break;
						}
					}
					else{
						var today = new Date();
						var time = pad(today.getHours()) + ":" + pad(today.getMinutes());
						Message('client', input.value, time);
						SendMessage('message', username, input.value);
					}
				}
				input.value = "";
				input.focus();
			}
			function pad(d) {
				return (d < 10) ? '0' + d.toString() : d.toString();
			}
			function SendMessage(msgid, msgsender, msgtext){
				var today = new Date();
				var time = pad(today.getHours()) + ":" + pad(today.getMinutes());
				var msg = {
						id: msgid,
						sender: msgsender,
						text: msgtext,
						time: time
					};
				websocket.send(JSON.stringify(msg));
			}
			function MessageImage(sender, src, time){
				var msgBody = document.createElement("div");
				var msg = document.createElement("div");
				var msgImg = document.createElement("img");
				msgImg.src = src;
				msgImg.style["max-width"] = "100%";
				var msgSender = document.createElement("p");
				if(sender === 'client'){
					msg.style.background = "#191919";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "right";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+username+", "+time+"</small>";
					msgSender.align = "RIGHT";
				}
				else{
					msg.style.background = "#0A0A0A";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "left";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+sender+", "+time+"</small>";
					msgSender.align = "LEFT";
				}
				msg.appendChild(msgImg);
				msg.appendChild(msgSender);
				msgBody.appendChild(msg);
				document.getElementById("chatbox").appendChild(msgBody);
				msg.scrollIntoView();
			}
			function Message(sender, text, time){
				var msgBody = document.createElement("div");
				var msg = document.createElement("div");
				var msgText = document.createElement("p");
				msgText.innerText = text;
				var msgSender = document.createElement("p");
				msg.style["overflow-wrap"] = "break-word";
				msg.style["word-wrap"] = "break-word";
				msg.style["hyphens"] = "auto";
				if(sender === 'client'){
					msg.style.background = "#191919";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "right";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+username+", "+time+"</small>";
					msgSender.align = "RIGHT";
				}
				else if (sender === 'server'){
					msg.align = "CENTER";
					msg.style["margin-top"] = 5;
					msg.style["margin-bottom"] = 5;
					msg.style.color = "#666"
				}
				else{
					msg.style.background = "#0A0A0A";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "left";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+sender+", "+time+"</small>";
					msgSender.align = "LEFT";
				}
				msgBody.className = "chatMessage";
				msg.onclick = function(){
					lastElement = this;
					ClearDropDowns();
					var dropdown = document.createElement("div");
					dropdown.className = "dropdown";
					dropdown.style.position = "absolute";
					dropdown.style.top = this.offsetTop;
					dropdown.style.left = this.children[0].offsetLeft;
					
					var optionQuote = document.createElement("p");
					optionQuote.innerHTML = "Quote";
					optionQuote.onclick = function(){document.getElementById("chatInput").value = '[quote]'+lastElement.children[0].textContent+'[/quote]'; document.getElementById("chatInput").focus(); ClearDropDowns();};
					var optionDelete = document.createElement("p");
					optionDelete.innerHTML = "Delete";
					optionDelete.onclick = function(){lastElement.parentNode.removeChild(lastElement); ClearDropDowns();};
					var optionCancel = document.createElement("p");
					optionCancel.innerHTML = "Cancel";
					optionCancel.onclick = function(){ClearDropDowns();};
					
					optionQuote.className = "option";
					optionDelete.className = "option";
					optionCancel.className = "option";
					
					dropdown.appendChild(optionQuote);
					dropdown.appendChild(optionDelete);
					dropdown.appendChild(optionCancel);
					
					document.getElementById("chatbox").appendChild(dropdown);
				};
				msg.appendChild(msgText);
				msg.appendChild(msgSender);
				msgBody.appendChild(msg);
				console.log(msg.innerHTML);
				//BB CODE
				msg.innerHTML = msg.innerHTML.replace(/(\[img\])/g, '<img style="max-width: 100%" src="');
				msg.innerHTML = msg.innerHTML.replace(/(\[\/img\])/g, '">');
				msg.innerHTML = msg.innerHTML.replace(/(\[i\])/g, '<i>');
				msg.innerHTML = msg.innerHTML.replace(/(\[\/i\])/g, '</i>');
				msg.innerHTML = msg.innerHTML.replace(/(\[u\])/g, '<u>');
				msg.innerHTML = msg.innerHTML.replace(/(\[\/u\])/g, '</u>');
				msg.innerHTML = msg.innerHTML.replace(/(\[quote\])/g, '<blockquote style="background: #444; padding: 8px; margin: 4px; border-left-style: solid; ">');
				msg.innerHTML = msg.innerHTML.replace(/(\[\/quote\])/g, '</blockquote>');
				document.getElementById("chatbox").appendChild(msgBody);
				msg.scrollIntoView();
			}
			function ClearDropDowns(){
				var dropdowns = document.getElementsByClassName("dropdown");
				while (dropdowns[0]) {
					dropdowns[0].parentNode.removeChild(dropdowns[0]);
				}
			}
			function makeid(length) {
				var result           = '';
				var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
				var charactersLength = characters.length;
				for ( var i = 0; i < length; i++ ) {
					result += characters.charAt(Math.floor(Math.random() * charactersLength));
				}
				return result;
			}
			function Connect(){
				var ws = document.getElementById("ws");
				var un = document.getElementById("un");
				var error = document.getElementById("error");
				if(ws.value == ""){
					error.innerHTML = "WEBSOCKET URL BLANK";
					error.className = "";
					error.style.opacity = 1;
					setTimeout(function(){
						error.className = "fade";
						error.style.opacity = 0;
					}, 10);
					return;
				}
				if(un.value == ""){
					error.innerHTML = "USERNAME BLANK";
					error.className = "";
					error.style.opacity = 1;
					setTimeout(function(){
						error.className = "fade";
						error.style.opacity = 0;
					}, 10);
					return;
				}
				document.getElementById("connectbutton").disabled = true;
				username = un.value;
				websocket = new WebSocket(ws.value);
				websocket.onerror = function(event){
					error.innerHTML = "CONNECTION ERROR";
					error.className = "";
					error.style.opacity = 1;
					setTimeout(function(){
						error.className = "fade";
						error.style.opacity = 0;
					}, 10);
					websocket.close();
					document.getElementById("connectbutton").disabled = false;
					return;
				};
				websocket.onopen = function(event){
					console.log("OPENING");
					SendMessage('message', 'server', username+' has joined the session.');
					var servers = document.getElementById("servers");
					connected = true;
					servers.className = "fade-quick";
					servers.style.opacity = 0;
					document.getElementById("chat").style.display = "block";
					servers.style.display = "none";
				};
				websocket.onclose = function(event){
					//SendMessage('message', 'server', username+' has left the session.');
					console.log("CLOSING");
					setTimeout(function(){
						var servers = document.getElementById("servers");
						document.getElementById("chat").style.display = "none";
						servers.style.display = "block";
						servers.style.opacity = 1;
						document.getElementById("connectbutton").disabled = false;
					}, 1000);
				};
				websocket.onmessage = function(event) {
					var msg = JSON.parse(event.data);
					switch (msg.id){
						case 'message':
							Message(msg.sender, msg.text, msg.time);
							if(document.hasFocus()){
								document.getElementById("audio_message").play();
							}
							else{
								document.getElementById("audio_notification").play();
								var options = {
									body: msg.text,
									icon: "favicon.png"
								}
								var msgNotify = new Notification(msg.sender, options);
							}
							break;
						case 'kick':
							if(msg.sender == 'server'){
								if(msg.text == username){
									SendMessage('message', 'server', username+' has been kicked from the session.');
									websocket.close();
								}
							}
							break;
						case 'end':
							if(msg.sender == 'server'){
								websocket.close();
							}
							break;
						case 'image':
							MessageImage(msg.sender, msg.text, msg.time);
							if(document.hasFocus()){
								document.getElementById("audio_message").play();
							}
							else{
								document.getElementById("audio_notification").play();
							}
							break;
						case 'check':
							Message('server', username, '0');
							SendMessage('message', 'server', username);
							break;
					}
				}
			}
			function End() {
				if (connected){
					SendMessage('message', 'server', username+' has left the session.');
					websocket.close();
				}
			}
		</script>
		<link rel="shortcut icon" href="favicon.png">
		<link rel="manifest" href="manifest.json" crossorigin="use-credentials">
	</head>
	<body onload = "Start()" onbeforeunload="End()">
		<audio id="audio_message">
			<source src="message.mp3">
		</audio>
		<audio id="audio_notification">
			<source src="message1.mp3">
		</audio>
		<div id="servers" style="opacity: 0; position: absolute; width:100%; top:10%;">
			<img id="scplogo" src="scpf.png" style="display: block; margin-left: auto; margin-right: auto; width: 25%; margin-top: 2%;" onload="Load()">
			<h1 align=CENTER>S-Messenger</h1>
			<p align=CENTER>Websocket URL</p>
			<input id="ws" class=inputbox style="display:block; margin-left: auto; margin-right: auto; width: 75%; margin-bottom:8px;" placeholder="Enter websocket URL">
			<p align=CENTER>Username</p>
			<input id="un" class=inputbox style="display:block; margin-left: auto; margin-right: auto; width: 50%; margin-bottom:8px;" placeholder="Enter username">
			<button id="connectbutton" class=uibutton style="display:block; margin-left: auto; margin-right: auto;" onclick="Connect()">Connect</button>
			<h3 id="error" align=center style="color: red; opacity: 0;">ERROR</p>
		</div>
		<div id="chat" style="display: none;">
			<div id="chatbox" style="overflow-y: auto; max-height: calc(100% - 25px);"></div>
			<div class=bottomui>
				<input id="chatInput" class=inputbox><button id="sendButton" class=uibutton onclick="SendClick()">Send</button>
			</div>
		</div>
	</body>
</html>