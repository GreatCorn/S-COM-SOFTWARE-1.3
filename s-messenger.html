<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>S-Messenger</title>
		<style>
			body {
				font-family: "Courier";
				font-size: 16px;
				font-weight: bold;
				color: #fff;
				background: #000000;
				margin: 0;
				padding: 0;
			}
			
			p {
				margin-bottom: 0;
				margin-top: 0;
			}
			
			::-webkit-scrollbar {
				width: 11px;
			}

			::-webkit-scrollbar-track {
				background: #000; 
				border: 1px;
				border-style: solid;
				border-color: #898989;
			}

			::-webkit-scrollbar-thumb {
				background: #474747; 
			}

			::-webkit-scrollbar-thumb:hover {
				background: #555; 
			}
			
			.bottomui {
				position:fixed;
				bottom:0;
				left:0;
				width: 100%;
			}
			
			.inputbox {
				padding-left: 4px;
				background: #292929;
				color: #fff;
				border: none;
				outline: none;
				font-family: "Courier";
				font-size: 16px;
				font-weight: bold;
				height: 25px;
				width: calc(100% - 106px);
			}
			
			.uibutton {
				background: #191919;
				border: 1px solid #424242;
				font-family: "Courier";
				font-size: 16px;
				font-weight: bold;
				color: #fff;
				height: 25px;
				width: 106px;
				outline: none;
			}
			.uibutton:hover, .option:hover, .suggest:hover {
				background-color: #202020;
			}
			.uibutton:active, .option:active, .suggest:active {
				background: #404040;
			}
			.fade {
				opacity: 1;
				-webkit-transition: opacity 1s linear;
			}
			
			.fade-quick {
				opacity: 0;
				-webkit-transition: opacity 0.1s linear;
			}
			
			.option {
				cursor:pointer;
				padding: 14px;
				display: block;
				background: #292929;
				color: #fff;
				border: 1px solid #424242;
			}
			
			.suggest {
				cursor:pointer;
				padding: 4px;
				display: block;
				background: #191919;
				color: #fff;
				border: 1px solid #424242;
			}
			
			a:link {
				color:SteelBlue;
			}
			
			a:visited {
				color:RoyalBlue;
			}
			
			a:hover {
				color:SkyBlue;
			}
			
			a:active {
				color:SlateGray;
			}
		</style>
		<script>
			//GLOBALVARS
			var username = "";
			var websocket;
			var connected = false;
			var lastElement;
			var suggestcur = -1;
			var cmds = ["/clr", "/check", "/disconnect", "/info (str)", "/username {str}"];
			var cmdsEl = [];
			var bbs = ["[aud]", "[i]", "[img]", "[n]", "[quote]", "[u]", "[small]", "[big]", "[tt]", "[notag]", "[color]", "[url]"];
			bbs.sort();
			var bbsEl = [];
			let deferredPrompt;
			var pinnedMessage;

			//APPLICATION
			window.addEventListener('beforeinstallprompt', (e) => {
			  // Stash the event so it can be triggered later.
			  deferredPrompt = e;
			});
			if ('serviceWorker' in navigator) {
			  window.addEventListener('load', function() {
				navigator.serviceWorker.register('sw.js', {scope: '.'}).then(function(registration) {
				  // Registration was successful
				  console.log('ServiceWorker registration successful with scope: ', registration.scope);
				}, function(err) {
				  // registration failed :(
				  console.log('ServiceWorker registration failed: ', err);
				});
			  });
			}
			var CACHE_NAME = 'my-site-cache-v1';
			var urlsToCache = [
				'/',
				'/favicon.png',
				'/scpf.png',
				'/message.mp3',
				'/message1.mp3',
				'/manifest.json',
				'/pushpin.png'
			];

			self.addEventListener('install', function(event) {
			  // Perform install steps
			  event.waitUntil(
				caches.open(CACHE_NAME)
				  .then(function(cache) {
					console.log('Opened cache');
					return cache.addAll(urlsToCache);
				  })
			  );
			});
			
			
			
			function Start(){
				var input = document.getElementById("chatInput");
				
				input.addEventListener("keyup", function(event) {
					if (event.keyCode === 13) {
						document.getElementById("sendButton").click();
					}
					var suggestions = document.getElementsByClassName("suggest");
					var available = [];
					for (let i=0; i<suggestions.length; i++){
						if(suggestions[i].style.display == "block"){
							available.push(suggestions[i]);
						}
					}
					if (event.keyCode === 38) {
						if(suggestcur == -1){
							suggestcur = available.length;
						}
						if(input.value.charAt(0) == '/' || input.value.charAt(0) == '['){
							if(suggestcur > 0){
								suggestcur--;
							}
							input.value = available[suggestcur].innerText;
						}
					}
					if (event.keyCode === 40) {
						if(suggestcur == -1){
							suggestcur = 0;
						}
						if(input.value.charAt(0) == '/' || input.value.charAt(0) == '['){
							if(suggestcur < available.length-1){
								suggestcur++;
							}
							input.value = available[suggestcur].innerText;
						}
					}
				});
				Notification.requestPermission();
				for (let i=0; i<cmds.length; i++){
					var el = document.createElement("p");
					el.className = "suggest";
					el.innerText = cmds[i];
					el.onclick = function (){
						input.value = this.innerText;
						input.focus();
						CheckCommand();
					}
					document.getElementById("suggestbox").appendChild(el);
					cmdsEl.push(el);
				}
				
				for (let i=0; i<bbs.length; i++){
					var el = document.createElement("p");
					el.className = "suggest";
					el.innerText = bbs[i];
					el.onclick = function (){
						input.value = this.innerText+this.innerText.slice(0, 1)+'/'+this.innerText.slice(1);
						input.focus();
						CheckCommand();
					}
					document.getElementById("suggestbox").appendChild(el);
					bbsEl.push(el);
				}
			}
			
			function Load(){
				var servers = document.getElementById('servers');
				servers.className='fade';
				servers.style.opacity=1;
				document.getElementById('ws').value = "wss://connect.websocket.in/v2/1?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjY0NWJkYzI2OGQ2NjkxMmY3MzI5MWM1YWE4YmY3YmI5YTkzMzEwOGUwYjRiYjA4NDgyOGI4YzliMzczMGVkNjhmMGI1MGQ2NGM5ODZhNmE4In0.eyJhdWQiOiI4IiwianRpIjoiNjQ1YmRjMjY4ZDY2OTEyZjczMjkxYzVhYThiZjdiYjlhOTMzMTA4ZTBiNGJiMDg0ODI4YjhjOWIzNzMwZWQ2OGYwYjUwZDY0Yzk4NmE2YTgiLCJpYXQiOjE1ODMxNzE1OTcsIm5iZiI6MTU4MzE3MTU5NywiZXhwIjoxNjE0NzA3NTk3LCJzdWIiOiI1OTgiLCJzY29wZXMiOltdfQ.KJGvQbVglNPlFE9S0ScLTdaLARCRwTvv8YzeL-HyUYMVX37YDU0fQy88iUH1uDhKf3sSq-ljdyplhn9ukMcY4pHGYneEPXnVJzRMM0O3NF-U97JL4FPcHjUmNkXwYV-o1AWo-B5h3NcGAeuhVDoJGDXbjP7pQt0YhtPzfU4rhGw-9JrKwvXNLmq5J3qHV-m3BkpE4QdXfR2KIHO_Rr78x_ufGkneRGCxkE5nyW2vVLrP-_BDCKIvaP7dS6oob_gRvjmVMJaRITNKsbJqpyZBnkDvdKzXjxlgcvDQh2ZXMFT63RCIBh3o29lr7BlmOQs5CXCz7Tq0EFp8o4iHyWdnXAqoBIzadT1_0hkRo6KojYhMtLNpXDuba-7QvPBO556Bp8VzT0QLPSBdl6_N--LcqrQ90UtJpkiJIVf4dQLfST8TIitTHiqGg6cJSUkqhDwIACSMG7Ah_b09zzciJ8n_ILCEhclGH66L81jvvpGtHfnCsocBPJ_coIECAuyxC074T2s4gdj0Jral9GYtjeb4JGCmgtgMul1-vwk8wjWK4tT2LGsdiUqbnovhK-wNLa2V4gQnzb2H1YgKmf1LKcmUOxZMpnJFfXm6rBw-N6HzKLfq0O8QztGOsseU9f7nzQZQZLeixXIWd9MLI9tDzvzxsxhZHMl9cVa1jyU_9lVkOlw";
				document.getElementById('un').value = makeid(8);
			}
			
			function SendClick(){
				suggestcur = -1;
				var input = document.getElementById("chatInput");
				if(input.value != ""){
					if(input.value.charAt(0) == '/'){
						var read="";
						for(let i=1; i<input.value.length; i++){
							if (input.value.charAt(i) == " "){
								break;
							}
							read += input.value.charAt(i);
						}
						console.log(read);
						switch (read){
							case "clr":
								var msgs = document.getElementsByClassName("chatMessage");
								while (msgs[0]) {
									msgs[0].parentNode.removeChild(msgs[0]);
								}
								break;
								
							case "check":
								Message('server', 'Online users:', '0');
								SendMessage('message', 'server', 'Online users:');
								
								SendMessage('check', 'server', '');
								
								Message('server', username, '0');
								SendMessage('message', 'server', username);
								break;
								
							case "username":
								var prs = "";
								for(let i=10; i<input.value.length; i++){
									prs+=input.value.charAt(i);
								}
								if(prs == ""){
									Message("server", "Invalid username.");
									return;
								}
								Message("server", username+" changed username to "+prs+".");
								SendMessage('message', 'server', username+" changed username to "+prs+".");
								username = prs;
								break;
								
							case "disconnect":
								End();
								break;
								
							case "info":
								var prs = "";
								for (let i=6; i<input.value.length; i++){
									prs+=input.value.charAt(i);
								}
								if(prs == ""){
									Message('server', "S-Messenger 1.1.2");
									Message('server', navigator.platform+Define(navigator.oscpu)+" "+navigator.language+". "+Define(navigator.vendor));
									Message('server', Define(navigator.userAgent));
								}
								else{
									switch (prs){
										case "clr":
											Message('server', "/clr");
											Message('server', "Clears the screen of all client text.");
											break;
											
										case "check":
											Message('server', "/check");
											Message('server', "Publicly displays all online clients.");
											break;
											
										case "disconnect":
											Message('server', "/disconnects");
											Message('server', "Disconnects client from the currently connected server and returns to the menu screen.");
											break;
											
										case "info":
											Message('server', "/info (str)");
											Message('server', "Privately displays info about the client, specified command or tag.");
											Message('server', "(str) - the specified command or tag. To display client info leave blank.");
											Message('server', "Example of usage: /info clr shows info about /clr command.");
											Message('server', "[notag]/info [img] shows info about [img] tag.");
											break;
											
										case "username":
											Message('server', "/username {str}");
											Message('server', "Publicly changes client's displayed username to specified.");
											Message('server', "{str} - the specified username. This is required to execute the command.");
											Message('server', "Example of usage: [i]/username CONT_999[/i]");
											break;
											
										case "[aud]":
											Message('server', "[notag][aud]{link}[/aud]");
											Message('server', "Allows embedding direct audio links as playable audio. End tag required.");
											Message('server', "{link} - the specified direct audio link.");
											Message('server', "Example: [aud]message.mp3[/aud]");
											break;
											
										case "[big]":
											Message('server', "[notag][big][/big]");
											Message('server', "Makes inner text relatively bigger. End tag required.");
											Message('server', "Example: [big]This text is big.[/big]");
											break;
											
										case "[color]":
											Message('server', "[notag][color={color}][/color]");
											Message('server', "Makes inner text colored in the specified color. End tag required.");
											Message('server', "{color} - the specified color. Can be a CSS constant or a hex value.");
											Message('server', "Example: [color=blue]This text is colored blue.[/color]");
											break;
											
										case "[i]":
											Message('server', "[notag][i][/i]");
											Message('server', "Makes inner text italic. End tag required.");
											Message('server', "Example: [i]This text is italic.[/i]");
											break;
											
										case "[img]":
											Message('server', "[notag][img]{link}[/img]");
											Message('server', "Allows embedding direct image links as displayed images. End tag required.");
											Message('server', "{link} - the specified direct image link.");
											Message('server', "Example: [img]scpf.png[/img]");
											break;
											
										case "[n]":
											Message('server', "[⁣n]");
											Message('server', "Adds newline to text. End tag not required.");
											Message('server', "Example: New[n]line.");
											
										case "[notag]":
											Message('server', "[⁣notag]");
											Message('server', "Disables tags in message. End tag not required.");
											Message('server', "Example: [notag][i]This text is not italic.[/i]");
											break;
											
										case "[quote]":
											Message('server', "[notag][quote][/quote]");
											Message('server', "Makes inner text quoted. End tag required.");
											Message('server', "Example: [quote]This text is quoted.[/quote]");
											break;
											
										case "[small]":
											Message('server', "[notag][small][/small]");
											Message('server', "Makes inner text relatively smaller. End tag required.");
											Message('server', "Example: [small]This text is small.[/small]");
											break;
											
										case "[tt]":
											Message('server', "[notag][tt][/tt]");
											Message('server', "Makes inner text in a fixed-size font. End tag required.");
											Message('server', "Example: [tt]This text is in a fixed-size font.[/tt]");
											break;
											
										case "[u]":
											Message('server', "[notag][u][/u]");
											Message('server', "Makes inner text underlined. End tag required.");
											Message('server', "Example: [u]This text is underlined.[/u]");
											break;
											
										case "[url]":
											Message('server', "[notag][url={link}][/url]");
											Message('server', "[notag][url]{link}[/url]");
											Message('server', "Allows embedding clickable URL links. End tag required.");
											Message('server', "{link} - the specified URL link.");
											Message('server', "Example: [url=favicon.png]Logo of the SCP Foundation.[/url]");
											break;
											
										default:
											Message('server', 'No info found about "'+prs+'" command.');
											break;
										
									}
								}
								break;
								
							default:
								Message("server", "Unknown command.", "");
								break;
						}
					}
					else{
						var today = new Date();
						var time = pad(today.getHours()) + ":" + pad(today.getMinutes());
						Message('client', input.value, time);
						SendMessage('message', username, input.value);
					}
				}
				input.value = "";
				CheckCommand();
				input.focus();
			}
			function Define(str){
				if(str != null){
					return str;
				}
				return "";
			}
			function pad(d) {
				return (d < 10) ? '0' + d.toString() : d.toString();
			}
			function SendMessage(msgid, msgsender, msgtext){
				var today = new Date();
				var time = pad(today.getHours()) + ":" + pad(today.getMinutes());
				var msg = {
						id: msgid,
						sender: msgsender,
						text: msgtext,
						time: time
					};
				websocket.send(JSON.stringify(msg));
			}
			function MessageImage(sender, src, time){
				var msgBody = document.createElement("div");
				var msg = document.createElement("div");
				var msgImg = document.createElement("img");
				msgImg.src = src;
				msgImg.style["max-width"] = "100%";
				var msgSender = document.createElement("p");
				if(sender === 'client'){
					msg.style.background = "#191919";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "right";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+username+", "+time+"</small>";
					msgSender.align = "RIGHT";
				}
				else{
					msg.style.background = "#0A0A0A";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "left";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+sender+", "+time+"</small>";
					msgSender.align = "LEFT";
				}
				msg.appendChild(msgImg);
				msg.appendChild(msgSender);
				msgBody.appendChild(msg);
				document.getElementById("chatbox").appendChild(msgBody);
				msg.scrollIntoView();
			}
			function Message(sender, text, time){
				var msgBody = document.createElement("div");
				msgBody.className = "chatMessage";
				var msg = document.createElement("div");
				var msgText = document.createElement("p");
				msgText.className = "messageText";
				msgText.innerText = text;
				var msgSender = document.createElement("p");
				msg.style["overflow-wrap"] = "break-word";
				msg.style["word-wrap"] = "break-word";
				msg.style["hyphens"] = "auto";
				if(sender === 'client'){
					msg.style.background = "#191919";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "right";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+username+", "+time+"</small>";
					msgSender.align = "RIGHT";
				}
				else if (sender === 'server'){
					msg.align = "CENTER";
					msg.style["margin-top"] = 5;
					msg.style["margin-bottom"] = 5;
					msg.style.color = "#666"
				}
				else{
					msg.style.background = "#0A0A0A";
					msg.style.padding = 14;
					msgBody.style["margin-top"] = 5;
					msgBody.style["margin-bottom"] = 5;
					msgBody.style["min-width"] = "100%";
					msg.style["max-width"] = "75%";
					msg.style.float = "left";
					msgBody.style.overflow = "auto";
					msgSender.innerHTML = "<small>"+sender+", "+time+"</small>";
					msgSender.align = "LEFT";
				}
				msg.onclick = function(){
					lastElement = this;
					ClearDropDowns();
					var dropdown = document.createElement("div");
					dropdown.className = "dropdown";
					dropdown.style.position = "absolute";
					
					var optionQuote = document.createElement("p");
					optionQuote.innerHTML = "Quote text";
					optionQuote.onclick = function(){
						for(let i=0; i<lastElement.children.length; i++){
							if(lastElement.children[i].className == "messageText"){
								document.getElementById("chatInput").value = '[quote]'+lastElement.children[i].textContent+'[/quote]';
								document.getElementById("chatInput").focus();
								ClearDropDowns();
								break;
							}
						}
					};
					var optionDelete = document.createElement("p");
					optionDelete.innerHTML = "Delete message";
					optionDelete.onclick = function(){lastElement.parentNode.removeChild(lastElement); ClearDropDowns();};
					var optionCopy = document.createElement("p");
					optionCopy.innerHTML = "Copy text";
					optionCopy.onclick = function(){
						for(let i=0; i<lastElement.children.length; i++){
							if(lastElement.children[i].className == "messageText"){
								var txtarea = document.createElement('textarea');
								txtarea.value = lastElement.children[i].innerText;
								document.body.appendChild(txtarea);
								txtarea.select();
								document.execCommand('copy');
								txtarea.parentNode.removeChild(txtarea);
								ClearDropDowns();
								break;
							}
						}
					};
					var optionPin = document.createElement("p");
					optionPin.innerHTML = "Pin message";
					optionPin.onclick = function(){
						pinnedMessage = lastElement;
						SendMessage('pin', 'server', pinnedMessage.children[0].innerText);
						PinMessage(pinnedMessage.children[0].innerText);
						ClearDropDowns();
					};
					var optionCancel = document.createElement("p");
					optionCancel.innerHTML = "Cancel";
					optionCancel.onclick = function(){ClearDropDowns();};

					
					optionQuote.className = "option";
					optionDelete.className = "option";
					optionCopy.className = "option";
					optionPin.className = "option";
					optionCancel.className = "option";
					
					dropdown.appendChild(optionQuote);
					dropdown.appendChild(optionDelete);
					dropdown.appendChild(optionCopy);
					dropdown.appendChild(optionPin);
					dropdown.appendChild(optionCancel);
					
					msgBody.appendChild(dropdown);
					
					var rect = this.getBoundingClientRect();
					var droprect = dropdown.getBoundingClientRect();
					console.log(droprect);
					if(rect.top>document.body.getBoundingClientRect().height-droprect.height-25){
						dropdown.style.top = document.body.getBoundingClientRect().height-droprect.height-25;
					}
					else if(rect.top<0){
						dropdown.style.top = 0;
					}
					else{
						dropdown.style.top = rect.top;
					}
					if(rect.left>document.body.getBoundingClientRect().width-droprect.width-25){
						dropdown.style.left = document.body.getBoundingClientRect().width-droprect.width-25;
					}
					else{
						dropdown.style.left = rect.left;
					}
				};
				msg.appendChild(msgText);
				//BB CODE
				if(!msgText.innerText.includes("[notag]")){
					msgText.innerText = msgText.innerText.replace(/(\[img\])/g, "<img style='max-width: 100%' src='");
					msgText.innerText = msgText.innerText.replace(/(\[\/img\])/g, "'>");
					msgText.innerText = msgText.innerText.replace(/(\[vid\])/g, "<video controls style='max-width: 100%'><source src='");
					msgText.innerText = msgText.innerText.replace(/(\[\/vid\])/g, "'></video>");
					msgText.innerText = msgText.innerText.replace(/(\[aud\])/g, "<audio controls style='max-width: 100%'><source src='");
					msgText.innerText = msgText.innerText.replace(/(\[\/aud\])/g, "'></audio>");
					//[COLOR]
					var colorCount = (msgText.innerText.match(/(\[color=)/g) || []).length;
					for(let i=0; i<colorCount; i++){
						var prs="";
						for(let j=msgText.innerText.indexOf("[color=")+7; j<msgText.innerText.length; j++){
							if(msgText.innerText.charAt(j) == "]"){
								break;
							}
							prs+=msgText.innerText.charAt(j);
						}
						console.log(prs);
						msgText.innerText = msgText.innerText.replace("[color="+prs+"]", "<span style='color: "+prs+"'>");
					}
					msgText.innerText = msgText.innerText.replace(/(\[\/color\])/g, "</span>");
					//[URL=]
					var urlCount = (msgText.innerText.match(/(\[url=)/g) || []).length;
					for(let i=0; i<urlCount; i++){
						var prs="";
						for(let j=msgText.innerText.indexOf("[url=")+5; j<msgText.innerText.length; j++){
							if(msgText.innerText.charAt(j) == "]"){
								break;
							}
							prs+=msgText.innerText.charAt(j);
						}
						console.log(prs);
						msgText.innerText = msgText.innerText.replace("[url="+prs+"]", "<a href="+prs+">");
					}
					//[URL]
					var urlCount = (msgText.innerText.match(/(\[url\])/g) || []).length;
					for(let i=0; i<urlCount; i++){
						var prs="";
						for(let j=msgText.innerText.indexOf("[url]")+5; j<msgText.innerText.length; j++){
							if(msgText.innerText.charAt(j) == "["){
								if(msgText.innerText.charAt(j+1) == "/"){
									break;
								}
							}
							prs+=msgText.innerText.charAt(j);
						}
						console.log(prs);
						msgText.innerText = msgText.innerText.replace("[url]"+prs+"[/url]", "<a href="+prs+">"+prs+"</a>");
					}
					msgText.innerText = msgText.innerText.replace(/(\[\/url\])/g, "</a>");
					msgText.innerHTML = msgText.innerText;
					//<button style='font-size: 48px; color: #fff; background: #000;' onclick='ClearDropDowns();'>▶</button>
					msgText.innerHTML = msgText.innerHTML.replace(/(\[i\])/g, '<i>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[\/i\])/g, '</i>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[u\])/g, '<u>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[\/u\])/g, '</u>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[small\])/g, '<small>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[\/small\])/g, '</small>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[tt\])/g, '<tt>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[\/tt\])/g, '</tt>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[big\])/g, '<big>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[\/big\])/g, '</big>');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[quote\])/g, '<blockquote style="background: #444; padding: 8px; margin: 4px; border-left-style: solid; ">');
					msgText.innerHTML = msgText.innerHTML.replace(/(\[\/quote\])/g, '</blockquote>');
				}
				else{
					msgText.innerText = msgText.innerHTML.replace(/(\[notag\])/g, "");
					msgText.innerText = msgText.innerHTML.replace(/(\[\/notag\])/g, "");
				}
				msgText.innerHTML = msgText.innerHTML.replace(/(\[n\])/g, '<br>');
				msgText.innerHTML = msgText.innerHTML.replace(/(\[\/n\])/g, '</>');
				
				msgSender.innerHTML = "<small>"+msgSender.innerText+"<small>";
				msg.appendChild(msgSender);
				msgBody.appendChild(msg);
				document.getElementById("chatbox").appendChild(msgBody);
				msg.scrollIntoView();
			}
			function ClearDropDowns(){
				var dropdowns = document.getElementsByClassName("dropdown");
				while (dropdowns[0]) {
					dropdowns[0].parentNode.removeChild(dropdowns[0]);
				}
			}
			function PinMessage(text){
				/*
				var lastpin = document.getElementById('pin');
				if(lastpin != null){
					lastpin.parentNode.removeChild(lastpin);
				}
				var pin = document.createElement('p');
				pin.id = "pin";
				pin.style.background = "#292929";
				//pin.style.position = "absolute";
				pin.style["min-width"] = "100%";
				pin.style.overflow = "auto";
				pin.style.top = "0px";
				pin.style["box-sizing"] = "border-box";
				pin.style.padding = 4;
				pin.innerHTML = "<img style='height: 1em; margin-right: 0.5em; margin-left: 0.2em;' src='pushpin.png'>"+text;
				pin.onclick = function(){pinnedMessage.scrollIntoView();}
				document.getElementById("chat").insertBefore(pin, document.getElementById("chatbox"));
				setTimeout(function(){
					const mhstr = `calc(100% - ${25 + pin.getBoundingClientRect().height}px);`;
					console.log(pin.getBoundingClientRect().height);
					console.log(mhstr);
					document.getElementById("chatbox").style.maxHeight = mhstr;
				}, 10);
				*/
			}
			function makeid(length) {
				var result           = '';
				var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
				var charactersLength = characters.length;
				for ( var i = 0; i < length; i++ ) {
					result += characters.charAt(Math.floor(Math.random() * charactersLength));
				}
				return result;
			}
			function Connect(){
				var ws = document.getElementById("ws");
				var un = document.getElementById("un");
				var error = document.getElementById("error");
				if(ws.value == ""){
					error.innerHTML = "WEBSOCKET URL BLANK";
					error.className = "";
					error.style.opacity = 1;
					setTimeout(function(){
						error.className = "fade";
						error.style.opacity = 0;
					}, 10);
					return;
				}
				if(un.value == ""){
					error.innerHTML = "USERNAME BLANK";
					error.className = "";
					error.style.opacity = 1;
					setTimeout(function(){
						error.className = "fade";
						error.style.opacity = 0;
					}, 10);
					return;
				}
				document.getElementById("connectbutton").disabled = true;
				username = un.value;
				websocket = new WebSocket(ws.value);
				websocket.onerror = function(event){
					error.innerHTML = "CONNECTION ERROR";
					error.className = "";
					error.style.opacity = 1;
					setTimeout(function(){
						error.className = "fade";
						error.style.opacity = 0;
					}, 10);
					websocket.close();
					document.getElementById("connectbutton").disabled = false;
					return;
				};
				websocket.onopen = function(event){
					console.log("OPENING");
					SendMessage('message', 'server', username+' has joined the session.');
					SendMessage('pinrequest', username, '');
					var servers = document.getElementById("servers");
					connected = true;
					servers.className = "fade-quick";
					servers.style.opacity = 0;
					document.getElementById("chat").style.display = "block";
					servers.style.display = "none";
				};
				websocket.onclose = function(event){
					//SendMessage('message', 'server', username+' has left the session.');
					ClearDropDowns();
					var lastpin = document.getElementById('pin');
					if(lastpin != null){
						lastpin.parentNode.removeChild(lastpin);
					}
					var msgs = document.getElementsByClassName("chatMessage");
					while (msgs[0]) {
						msgs[0].parentNode.removeChild(msgs[0]);
					}
					console.log("CLOSING");
					setTimeout(function(){
						var servers = document.getElementById("servers");
						document.getElementById("chat").style.display = "none";
						servers.style.display = "block";
						servers.style.opacity = 1;
						document.getElementById("connectbutton").disabled = false;
					}, 1000);
				};
				websocket.onmessage = function(event) {
					var msg = JSON.parse(event.data);
					switch (msg.id){
						case 'message':
							Message(msg.sender, msg.text, msg.time);
							if(document.hasFocus()){
								document.getElementById("audio_message").play();
							}
							else{
								document.getElementById("audio_notification").play();
								var options = {
									body: msg.text,
									icon: "favicon.png"
								}
								var msgNotify = new Notification(msg.sender, options);
							}
							break;
						case 'kick':
							if(msg.sender == 'server'){
								if(msg.text == username){
									SendMessage('message', 'server', username+' has been kicked from the session.');
									websocket.close();
								}
							}
							break;
						case 'end':
							if(msg.sender == 'server'){
								websocket.close();
							}
							break;
						case 'image':
							MessageImage(msg.sender, msg.text, msg.time);
							if(document.hasFocus()){
								document.getElementById("audio_message").play();
							}
							else{
								document.getElementById("audio_notification").play();
							}
							break;
						case 'check':
							Message('server', username, '0');
							SendMessage('message', 'server', username);
							break;
							
						case 'pin':
							PinMessage(msg.text);
							break;
						case 'unpin':
							var lastpin = document.getElementById('pin');
							if(lastpin != null){
								lastpin.parentNode.removeChild(lastpin);
							}
							break;
						case 'pinrequest':
							SendMessage('pin', 'server', document.getElementById("pin").innerText);
							break;
					}
				}
			}
			function End() {
				if (connected){
					SendMessage('message', 'server', username+' has left the session.');
					websocket.close();
				}
			}
			function CheckCommand(){
				suggestcur = -1;
				var input = document.getElementById("chatInput").value;
				if (input.length > 0){
					if(input.charAt(0) == "/"){
						document.getElementById("suggestbox").style.display = "block";
					}
					else if(input.charAt(input.length-1) == "["){
						document.getElementById("suggestbox").style.display = "block";
					}
					else if(input.charAt(input.length-1) == "]"){
						document.getElementById("suggestbox").style.display = "none";
					}
					for (let i=0; i<cmds.length; i++){
						if(cmds[i].includes(input)){
							cmdsEl[i].style.display = "block";
						}
						else{
							cmdsEl[i].style.display = "none";
						}
					}
					for (let i=0; i<bbs.length; i++){
						if(input.includes("[")){
							if(bbs[i].includes(input.slice(input.lastIndexOf("[")))){
								bbsEl[i].style.display = "block";
							}
							else{
								bbsEl[i].style.display = "none";
							}
						}
						else{
							bbsEl[i].style.display = "none";
						}
					}
				}
				else{
					document.getElementById("suggestbox").style.display = "none";
				}
			}
		</script>
		<link rel="shortcut icon" href="favicon.png">
		<link rel="manifest" href="manifest.json" crossorigin="use-credentials">
	</head>
	<body onload = "Start()" onbeforeunload="End()">
		<audio id="audio_message">
			<source src="message.mp3">
		</audio>
		<audio id="audio_notification">
			<source src="message1.mp3">
		</audio>
		<div id="servers" style="opacity: 0; position: absolute; width:100%; top:10%;">
			<img id="scplogo" src="scpf.png" style="display: block; margin-left: auto; margin-right: auto; width: 25%; margin-top: 2%;" onload="Load()">
			<h1 align=CENTER>S-Messenger</h1>
			<p align=CENTER>Websocket URL</p>
			<input id="ws" class=inputbox style="display:block; margin-left: auto; margin-right: auto; width: 75%; margin-bottom:8px;" placeholder="Enter websocket URL">
			<p align=CENTER>Username</p>
			<input id="un" class=inputbox style="display:block; margin-left: auto; margin-right: auto; width: 50%; margin-bottom:8px;" placeholder="Enter username">
			<button id="connectbutton" class=uibutton style="display:block; margin-left: auto; margin-right: auto;" onclick="Connect()">Connect</button>
			<h3 id="error" align=center style="color: red; opacity: 0;">ERROR</p>
		</div>
		<div id="chat" style="display: none; overflow-y: auto;">
			<div id="chatbox" style="overflow-y: auto; max-height: calc(100% - 25px);">
				<div id="suggestbox" style="display: none; position: absolute; bottom: 25px; overflow: auto;">
					
				</div>
			</div>
			<div class=bottomui>
				<input id="chatInput" class=inputbox oninput="CheckCommand()"><button id="sendButton" class=uibutton onclick="SendClick()">Send</button>
			</div>
		</div>
	</body>
</html>